# 주문 프로세스 통합 테스트 가이드

## 테스트 환경 준비

1. 개발 서버 실행:
   ```bash
   pnpm dev
   ```

2. 로그인 확인:
   - Clerk를 통한 로그인 필요
   - 테스트 계정 사용 또는 새로 가입

## 테스트 시나리오

### 1단계: 장바구니에 상품 담기

1. 홈페이지(`/`) 또는 상품 목록 페이지(`/products`)로 이동
2. 원하는 상품 클릭하여 상세 페이지로 이동
3. 수량 선택 후 "장바구니 담기" 버튼 클릭
4. 성공 Dialog 확인
5. 여러 상품 반복하여 담기

**검증 포인트:**
- ✅ 장바구니 담기 성공 메시지 표시
- ✅ Navbar 장바구니 아이콘에 개수 뱃지 업데이트
- ✅ 재고 부족 시 적절한 에러 메시지

### 2단계: 장바구니 페이지 확인

1. Navbar의 장바구니 아이콘 클릭 또는 `/cart`로 이동
2. 담긴 상품 목록 확인
3. 주문할 상품 선택 (체크박스)
4. 수량 조절 및 삭제 기능 확인

**검증 포인트:**
- ✅ 상품 목록이 정상적으로 표시됨
- ✅ 전체 선택/해제 작동
- ✅ 개별 선택 작동
- ✅ 수량 변경 시 소계 및 총 금액 업데이트
- ✅ 배송비 계산 정확 (5만원 이상 무료, 미만 3,000원)
- ✅ 선택된 상품 없을 때 주문하기 버튼 비활성화

### 3단계: 주문 페이지 이동

1. 장바구니에서 상품 선택
2. "주문하기" 버튼 클릭
3. `/checkout?items=id1,id2,id3` 형식으로 이동 확인

**검증 포인트:**
- ✅ URL에 선택된 아이템 ID가 쿼리 파라미터로 전달됨
- ✅ 비로그인 시 로그인 페이지로 리디렉션 (`/sign-in?returnUrl=/checkout`)
- ✅ 선택된 상품이 없으면 적절한 안내 메시지

### 4단계: 배송 정보 입력

1. 주문 페이지에서 배송 정보 입력
   - 수신자 이름
   - 전화번호 (010-1234-5678 형식)
   - 우편번호 (5자리 숫자)
   - 기본 주소
   - 상세 주소
   - 배송 메모 (선택)

**검증 포인트:**
- ✅ 필수 필드 누락 시 에러 메시지
- ✅ 전화번호 형식 검증 (010-0000-0000)
- ✅ 우편번호 형식 검증 (5자리 숫자)
- ✅ 최소/최대 길이 검증
- ✅ 배송 메모는 선택 사항

### 5단계: 주문 요약 확인

우측 사이드바(데스크톱) 또는 하단(모바일)에서 확인:

**검증 포인트:**
- ✅ 선택된 상품 목록 표시
- ✅ 각 상품의 수량, 가격, 소계 표시
- ✅ 총 상품 금액 정확
- ✅ 배송비 정확
- ✅ 최종 결제 금액 정확
- ✅ 무료 배송까지 남은 금액 안내 (해당 시)

### 6단계: 주문 생성

1. "결제하기" 버튼 클릭
2. 폼 검증 및 제출
3. Server Action 호출 확인 (콘솔 로그)

**검증 포인트:**
- ✅ 폼 검증 통과
- ✅ 로딩 상태 표시 ("처리 중...")
- ✅ 서버 로그 확인:
  - `createOrder` 그룹 로그
  - User ID 출력
  - 선택된 장바구니 아이템 ID 출력
  - 상품 검증 통과
  - 총 금액 계산
  - 주문 생성 성공
  - 주문 상품 생성 성공
- ✅ 성공 시 alert 메시지
- ✅ 홈페이지로 리디렉션 (임시, Phase 4에서 결제 페이지로 변경 예정)

### 7단계: 데이터베이스 확인

Supabase Dashboard에서 확인:

1. `orders` 테이블:
   - 새 주문 레코드 생성 확인
   - `clerk_id` 일치
   - `total_amount` 정확 (상품 금액 + 배송비)
   - `status` = 'pending'
   - `shipping_address` JSONB 데이터 확인
   - `order_note` 확인

2. `order_items` 테이블:
   - 각 상품마다 레코드 생성 확인
   - `order_id` 일치
   - `product_id` 일치
   - `product_name` (주문 시점 스냅샷)
   - `quantity` 정확
   - `price` (주문 시점 스냅샷)

**검증 포인트:**
- ✅ 주문 레코드 정상 생성
- ✅ 주문 상품 레코드 정상 생성 (선택된 상품 개수만큼)
- ✅ 배송 정보 JSONB 구조 정확
- ✅ 상품명/가격 스냅샷 저장

## 에러 케이스 테스트

### 1. 재고 부족
- 재고보다 많은 수량으로 주문 시도
- 예상: "재고가 부족합니다" 에러 메시지

### 2. 품절 상품
- 장바구니에 담은 후 관리자가 상품 비활성화
- 예상: "판매 중단된 상품입니다" 에러 메시지

### 3. 비로그인 접근
- 로그아웃 상태에서 `/checkout` 직접 접근
- 예상: 로그인 페이지로 리디렉션

### 4. 빈 선택
- 쿼리 파라미터 없이 `/checkout` 접근
- 예상: "주문할 상품이 없습니다" 안내

### 5. 유효하지 않은 아이템 ID
- 존재하지 않는 ID로 접근
- 예상: 빈 목록 또는 적절한 에러 처리

## 브라우저 콘솔 로그 확인

개발자 도구 콘솔에서 다음 로그 그룹 확인:

1. `fetchCartItems` - 장바구니 조회
2. `handleFormSubmit` - 폼 제출
3. `createOrder` - 주문 생성
   - User ID
   - Selected Cart Item IDs
   - Shipping Address
   - Order Note
   - Cart items fetched
   - All products validated
   - Total product price
   - Shipping fee
   - Total amount
   - Order created
   - Order items created

## 성능 확인

- ✅ 페이지 로딩 속도 적절
- ✅ 폼 제출 응답 시간 적절 (2초 이내)
- ✅ UI 반응성 좋음 (로딩 상태 표시)

## 다음 단계 (Phase 4)

- [ ] Toss Payments 결제 연동
- [ ] 결제 성공 페이지 구현
- [ ] 결제 실패 페이지 구현
- [ ] 결제 완료 후 장바구니 비우기
- [ ] 주문 상태 업데이트 (pending → confirmed)

